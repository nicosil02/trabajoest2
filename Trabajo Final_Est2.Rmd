---
title: "TITULO"
author: "Nicolas Silva"
date: "2023-06-01"
output: rmdformats::readthedown
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1.Introducción

texto

## 1.1. Pregunta de investigación

cómo se agrupan los países según su confianza en las instituciones y confianza interpersonal

## 1.2. Hipótesis

texto

# **2. Metodología: base de datos y métodos seleccionados**

## 2.1. Base de datos:

La presente investigación se basa en el "2017-2021 World Values Survey Wave 7". Esta base tiene como propósito recolectar los cambios en creencias, valores y motivaciones de las personas en casi 100 países que continen casi el 90% de la población del mundo. Esta investigación utilizará la versión más actual del cuestionario que corresponde a l ala sétima ola de WVS, cada ola significando un número más grande de sociedades que se han cubierto. El cuestionario WVS-7 consta de 290 preguntas y mide los valores culturales, las actitudes y las creencias sobre el género, la familia y la religión, las actitudes y la experiencia de la pobreza, la educación, la salud y la seguridad, la tolerancia social y la confianza, las actitudes hacia instituciones multilaterales, diferencias culturales y similitudes entre religiones y sociedades. A diferencia de previas olas, la WVS-7 incluye nuevos temas como la justicia, principios morales, corrupción, rendición de cuentas y riesgo, migración, seguridad nacional y gobernanza global. La recopilación de estos criterios de encuesta se encuentran al margen de la contriubucuón de los Objetivos de Desarrollo Sostenible y las metas definidas por la agenda post-2015 de la ONU.

Abrimos las librerías:

```{r message=FALSE, warning=FALSE}
library(rio)
library(dplyr)
library(tidyverse)
library(car)
library(countrycode)
library(polycor)
library(psych)
library(GPArotation)
library(lavaan)
library(semPlot)
library(rmdformats)
library(dendextend)
library(factoextra)
library(ggdendro)
options(scipen = 999)
library(NbClust)
library(latexpdf)
library(data.table)
library(tidyr)
library(sp)
library(BBmisc)
library(sf)
library(rgdal)
library(rgeos)
library(maptools)
library(ggplot2)
library(sf)
```

Cargamos la base de datos:

```{r}
WVS = import("WVS.rdata")
```

Decir qué base vamos a usar, sus características, de qué años, etc. Si bien la base tiene ciertos países, es importante decir que, después del proceso de limpieza, nos quedamos con 55. Es importante mencionarlos y decir a qué regiones pertenecen :)

Basarse del trabajo modelo que tenemos ayuda

También mencionar que variables vamos a usar y a qué categoría pertenecen (confianza instituciones y confianza interpersonal). **TAMBIEN TENEMOS QUE DESCRIBIRLAS.**

Seleccionamos las variables que se utilizarán:

```{r}
WVS_A <- WVS%>%select(B_COUNTRY,Q58:Q82, Q83:Q89)


```

Limpiamos la base, eliminando los valores correspondientes a respuesta no contabilizables y los valores perdidos.

```{r}
WVS_A <- WVS_A %>% 
  mutate(across(everything(), ~if_else(. %in% c(-1, -2, -3, -4, -5), NA_integer_, .)))
WVS_A <- na.omit(WVS_A)
```

**Transformamos la información:**

Para mayor comodidad y representatividad, agrupamos la data por país y convertimos la información a nivel individual a información a nivel país a través del promedio y redondeo de resultados de acuerdo al país.

```{r}
WVS_pais<- WVS_A %>%
  group_by(B_COUNTRY) %>%
  summarize(across(Q58:Q89, mean, na.rm = TRUE))
```

Renombramos las variables:

```{r}
WVS_pais <- WVS_pais%>%rename(Codigo=B_COUNTRY, familia=Q58, barrio=Q59, conocidos=Q60, rconocidos=Q61, preligion=Q62, nacionalidad=Q63, confianza_religion=Q64,confianza_FFAA=Q65,confianza_prensa= Q66,confianza_television= Q67, confianza_sindicatos = Q68, confianza_policia = Q69, confianza_justicia = Q70, confianza_gobierno = Q71, confianza_partidos = Q72, confianza_parlamento = Q73, confianza_serviciocivil = Q74, confianza_universidades = Q75, confianza_elecciones = Q76, confianza_granempresa = Q77, confianza_bancos =Q78, confianza_org_ambiental =Q79, confianza_org_mujeres = Q80, confianza_org_humanitaria = Q81, confianza_org_regional_relevante = Q82, confianza_onu = Q83, confianza_fmi = Q84, confianza_cci = Q85, confianza_otan = Q86, confianza_bm =Q87, confianza_oms =Q88, confianza_omc =Q89)
```

En el mismo sentido, agregamos una columna nueva para el nombre del país, de modo que sea más fácil identificar la correspondencia de los valores:

```{r}
WVS_pais$Codigo <- as.character(WVS_pais$Codigo)
data=import("all.csv")
WVS_pais$Nombre <- data$name[match(WVS_pais$Codigo, data$`country-code`)]
```

```{r}
WVS_pais$Nombre <- ifelse(WVS_pais$Codigo == 909, "Northern Ireland", WVS_pais$Nombre)

```

Asignamos una subdata tanto para trabajar la confianza en las instituciones como la interpersonal

**a)Confianza interpersonal**

```{r}
subdata_1=WVS_pais[,c(8:33)]
subdata_1
```

Ordenamos de manera ascendente para hacer más comprensible la información.

1.- confianza_religion

```{r}
subdata_1$confianza_religion= recode(subdata_1$confianza_religion, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_religion)
```

2.- confianza_FFAA

```{r}
subdata_1$confianza_FFAA= recode(subdata_1$confianza_FFAA, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_FFAA)
```

3.-confianza_prensa

```{r}
subdata_1$confianza_prensa= recode(subdata_1$confianza_prensa, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_prensa)
```

4.-confianza_television

```{r}
subdata_1$confianza_television= recode(subdata_1$confianza_television, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_religion)
```

5.-confianza_sindicatos

```{r}
subdata_1$confianza_sindicatos= recode(subdata_1$confianza_sindicatos, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_sindicatos)
```

6.- confianza_policia

```{r}
subdata_1$confianza_policia= recode(subdata_1$confianza_policia, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_policia)
```

7.- confianza_justicia

```{r}
subdata_1$confianza_justicia= recode(subdata_1$confianza_justicia, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_justicia)
```

8.-confianza_gobierno

```{r}
subdata_1$confianza_gobierno= recode(subdata_1$confianza_gobierno, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_gobierno)
```

9.-confianza_partidos

```{r}
subdata_1$confianza_partidos= recode(subdata_1$confianza_partidos, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_partidos)
```

10.-confianza_parlamento

```{r}
subdata_1$confianza_parlamento= recode(subdata_1$confianza_parlamento, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_parlamento)
```

11.- confianza_serviciocivil

```{r}
subdata_1$confianza_serviciocivil= recode(subdata_1$confianza_serviciocivil, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_serviciocivil)
```

12.-confianza_universidades

```{r}
subdata_1$confianza_universidades= recode(subdata_1$confianza_universidades, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_universidades)
```

13.- confianza_elecciones

```{r}
subdata_1$confianza_elecciones= recode(subdata_1$confianza_elecciones, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_elecciones)
```

14.- confianza_granempresa

```{r}
subdata_1$confianza_granempresa= recode(subdata_1$confianza_granempresa, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_granempresa)
```

15.-confianza_bancos

```{r}
subdata_1$confianza_bancos= recode(subdata_1$confianza_bancos, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_bancos)
```

16.- confianza_org_ambiental

```{r}
subdata_1$confianza_org_ambiental= recode(subdata_1$confianza_org_ambiental, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_org_ambiental)
```

17.- confianza_org_mujeres

```{r}
subdata_1$confianza_org_mujeres= recode(subdata_1$confianza_org_mujeres, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_org_mujeres)
```

18.-confianza_org_humanitaria

```{r}
subdata_1$confianza_org_humanitaria= recode(subdata_1$confianza_org_humanitaria, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_org_humanitaria)
```

19.-confianza_org_regional_relevante

```{r}
subdata_1$confianza_org_regional_relevante= recode(subdata_1$confianza_org_regional_relevante, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_org_regional_relevante)
```

20.-confianza_onu

```{r}
subdata_1$confianza_onu= recode(subdata_1$confianza_onu, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_onu)
```

21.-confianza_fmi

```{r}
subdata_1$confianza_fmi= recode(subdata_1$confianza_fmi, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_fmi)
```

22.-confianza_cci

```{r}
subdata_1$confianza_cci= recode(subdata_1$confianza_cci, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_cci)

```

23.-confianza_otan

```{r}
subdata_1$confianza_otan= recode(subdata_1$confianza_otan, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_otan)
```

24.-confianza_bm

```{r}
subdata_1$confianza_bm= recode(subdata_1$confianza_bm, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_bm)
```

25.- confianza_oms

```{r}
subdata_1$confianza_oms= recode(subdata_1$confianza_oms, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_oms)

```

26.-confianza_omc

```{r}
subdata_1$confianza_omc= recode(subdata_1$confianza_omc, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_omc)
```

**b) Confianza interpersonal**

Creamos la subdata para confianza interpersonal:

```{r}
subdata_2 <- WVS_pais[,c(2:7)]
```

Ordenamos de manera ascendente.

1)  

```{r}
subdata_2$familia= recode(subdata_2$familia, "1=4;2=3;3=2;4=1")
table(subdata_2$familia)
```

2)  

```{r}
subdata_2$barrio= recode(subdata_2$barrio, "1=4;2=3;3=2;4=1")
table(subdata_2$barrio)
```

3)  

```{r}
subdata_2$conocidos= recode(subdata_2$conocidos, "1=4;2=3;3=2;4=1")
table(subdata_2$conocidos)
```

4)  

```{r}
subdata_2$rconocidos= recode(subdata_2$rconocidos, "1=4;2=3;3=2;4=1")
table(subdata_2$rconocidos)
```

5)  

```{r}
subdata_2$preligion= recode(subdata_2$preligion, "1=4;2=3;3=2;4=1")
table(subdata_2$preligion)
```

6)  

```{r}
subdata_2$nacionalidad= recode(subdata_2$nacionalidad, "1=4;2=3;3=2;4=1")
table(subdata_2$nacionalidad)

```

Asignamos el nombre de los países como primera columna y la eliminamos de la data principal (WVS_pais)

texto

## 2.2. Métodos seleccionados

texto

# 3. Presentación y análisis de resultados - Confianza en las instituciones

Trabajo con 26 variables que refieren a la confianza en las instituciones

## 3.1. Análisis factorial exploratorio:

```{r}
str(subdata_1)
```

### Calculamos la matriz de correlación

Al estar trabajando con variables categóricas ordinales, obtamos por ejecutar la correlación policórica.

```{r}

poly_cor1 = polychoric(subdata_1)
poly_cor1

```

### 

**Creamos un gráfico con la matriz de correlaciones:**

```{r}
corMatrix=poly_cor1$rho 
cor.plot(corMatrix,
          numbers=T, #Se muestren los numeros de las correlaciones
          upper=F, #Que aparezca la segunda parte
          main= "Matriz de correlaciones",#Titulo
          show.legend=T)#Mostrar leyenda
```

Con la matriz previa podemos observar la proporción de relación entre dos variabales. La relación se explica mediante la intensidad de los colores de la matriz y sus explicaciones en la leyenda. Mientras más azul, será más cercano a 1 y mayor será dicha proporción. Por el contrario, mientras más rojo, será menos la relación y cercano a -1. Esto se elaboró para buscar si existen grupos de variables correlacionadas, y posteriormente, conformar las variables latentes.

**Verificamos si los datos son factorizables:**

Test de Kaiser-Meyer-Olkin factor adequacy (KMO):

```{r}
psych::KMO(subdata_1) 
```

Escala - Test KMO

0 a 0.5= no se debe de realizar

0.5 a 0.7= aceptable

0.7 a 1= muy bueno

Con esta prueba lo que buscamos es que la correlación parcial sea mayor a 0.5. Por ende, se espera que los valores resultantes, esten más ceranos a 1. En este caso, observamos que los resultados se encuentran entre 0.57 hasta 0.97, con un Overall MSA de 0.88, lo cual es muy bueno. Esto nos indica que los valores de las variables son factorizables.

**Verificamos si la matriz de correlación es adecuada**

Test de Bartlett

```{r}
cortest.bartlett(corMatrix,n=nrow(subdata_1))$p.value>0.05
```

H0= Matriz de correlación es igual a la matriz de identidad

Ha= Matriz de correlación NO es igual a la matriz de identidad (\<0.05)

Con este test, lo que buscamos es que se rechace la H0, la cual implica que la matriz de correlacion es una matriz identidad. "FALSE" nos indica que existe un p-value mayor a 0.05, de modo que se rechaza la H0 y se acepta la Ha, de modo que la matriz sí es adecuada.

### **Determinamos cuántos factores latententes puede redimensionar la data:**

### **Grafico de sedimentación:**

Elaboramos este gráfico para determinar en cuántos factores podemos redimensionar nuestros variables y valores de nuestra subdata.

```{r}
fa.parallel(corMatrix, fm="pa", fa="fa", main = "Scree Plot")
```

**Eigen values - Autovalores**

```{r}
eigenf = eigen(cor(subdata_1, use="complete"))
eigenf$values
```

(Criterio de Kaiser : se deben retener todos los factores que tengan un autovalor mayor de 1.0.)

Tras observar los autovalores (cantidad de la varianza total que está explicada por cada factor) y el gráfico de sedimentación podemos concluir que los más apropiado sería distribuir las variables en cuatro (4) factores. Elegir un número menor, como nos propone el gráfico, sería arriesgarnos a que un factor explique variables que parecen no tener relación por las dimensiones de confianza institucional que explican.

### **Solicitamos el número de componentes**

Rotamos para acomodar las variables latentes para que se correlacionen con su respectivo grupo de datos.

Utilizamos la rotación varimax, puesto que minimiza el número de variables con cargas altas en un factor, mejorando así la interpretación de factores.

```{r}
factorial_exp1 <- fa(subdata_1,nfactors = 5,rotate="varimax", fm="minres")
factorial_exp1
```

Se nos muestra la capacidad explicativa de los factores respecto a las variables, de modo que se establecen relaciones entre estas.

### **Diagramamos**

Observamos los factores y por cuáles variables se encuentran compuestas en relación a sus autovalores encontrados. Esto se hace en función de la varianza que comparten las variables con el factor. Todas las variables comparten varianza, pero algunas han compartido más con un factor que con los otros dos.

```{r}
fa.diagram(factorial_exp1)
```

```{r}
print(factorial_exp1$loadings,cutoff = 0.4)
```

**Evaluamos el Análisis Factorial Exploratorio solicitado**

Para entender a mayor profundidad la distribución de factores, es recomendable plantear las siguientes interrogantes:

-   **¿Qué variables aportaron mas a los factores?**

```{r}
sort(factorial_exp1$communality)
```

Las variables confianza en el Banco Mundial y confianza en el Fondo Monetario Internacional son las que aportaron más significativamente a los factores. Esto podría estar relacionado al sistema económico neoliberal instaurado mundialmente que legitima y otorga más confianzas a aquellas instituciones encargadas de la economía y comercio.

-   **¿Qué variables contribuyen a mas de un factor?**

```{r}
sort(factorial_exp1$complexity)
```

Las variables de confianza en gobierno y confianza en parlamento contribuyen a más de un factor. Esto pone en evidencia que estas instituciones están muy presentes en la opinión de las personas, probablemente porque en muchas partes del mundo dificultades para instaurar su legitimidad y confianza considerando el clima de ascenso de la autocracia mundial.

-   **¿Qué variables observables tiene un componente "único" más grande?**

```{r}
sort(factorial_exp1$uniquenesses)
```

Las variables de "religión" y "FFAA" contienen un componente único más grande, significando que tienen la menor cantidad de información en común. Probablemente esto se debe porque posiciones afines a la religión van en contra con la valorizacióna las FFAA. No obstante, también puede ser muy subjetivo ya que la influencia de la religión y las FF.AA en muchas sociedad ha disminuido y por tanto no influyen mucho en la confianza de las personas.

## **3.2. Análisis Factorial Confirmatorio**

Una vez hecho el análisis factorial exploratorio, pasaremos a realizar el análisis factorial confirmatorio para contrastar el modelo sugerido. Así podremos corroborar si lo planteado es adecuado.

```{r}
Modelo_confir1 = "FAC1 =~confianza_otan+ confianza_fmi+confianza_cci+confianza_omc+confianza_onu+confianza_bm+confianza_org_regional_relevante+confianza_sindicatos+confianza_granempresa+confianza_bancos+confianza_prensa
                FAC2 =~ confianza_policia+confianza_justicia+confianza_serviciocivil+confianza_FFAA+confianza_elecciones+confianza_parlamento+confianza_gobierno+confianza_partidos
               FAC3 =~ confianza_religion+confianza_television
                FAC4 =~ confianza_org_ambiental+confianza_org_humanitaria+confianza_org_mujeres+confianza_universidades+confianza_oms"

Modelo_confir1
```

```{r}
modelo=cfa(Modelo_confir1, data=subdata_1)
summary(modelo,fit.measures=F)
```

A pesar de no contar con errores en la asignación de factores, las asignaciones propias de R carecen de sentido en algunos casos. Por ejemplo, en el FAC4, si bien podríamos catolar al cluster como de "organizaciones", vemos que también incluye a "universidades", una institución educativa. De esta forma, a continuación se va a proponer un nuevo modelo utilizando conocimientos desde la Ciencia Política, que permita construir una distribución de patrones adecuada para explicar la confianza institucional.

```{r}
Modelo_confir3 = "F1_Confianza en las OI =~confianza_org_regional_relevante+confianza_onu+confianza_bm+confianza_oms+confianza_omc+confianza_otan+ confianza_cci+confianza_fmi
                 F2_Confianza en los Medios de Comunicación  =~ confianza_television + confianza_prensa
                F3_Confianza en las Instituciones Políticas y Legales =~ confianza_gobierno+confianza_partidos+confianza_parlamento+confianza_elecciones+confianza_serviciocivil + confianza_justicia
              F4_Confianza en las instituciones de seguridad  =~ confianza_policia + confianza_FFAA
                F5_Confianza en Instituciones Educativas y Espirituales =~confianza_religion+ confianza_universidades
F6_Confianza en Instituciones Sociales=~ confianza_sindicatos + confianza_granempresa+
confianza_org_ambiental+confianza_org_mujeres+confianza_org_humanitaria"
Modelo_confir3
```

```{r}
modelo3=cfa(Modelo_confir3, data=subdata_1)
summary(modelo3,fit.measures=F)
```

Tras lo realizado, se obtuvieron seis factores:

**F1 - Confianza en las Organizaciones Internacionales** (Incluye confianza en: Organizaciones regionales relevantes, la Organización de las Naciones Unidas, Organización Mundial de la Salud, Organización Mundial del Comercio, Organización del Tratado del Atlántico Norte, Corte Penal Internacional, Fondo Monetario Internacional)

-   Esta agrupación se sustenta usando los criterios de la internacionalista Esther Barbé que define una organización internacional como una asociación de 3 o más Estados, establecida mediante un acuerdo, para la consecución de objetivos comunes (1995). Asimismo, esta debe ser una estructura institucional con órganos permanentes, propios y autónomos de los estados miembros (Barbé, 1995). De esta forma, los criterios de esta definición cumplen con todos las instituciones que componen este factor.

**F2 - Confianza en los medios de comunicación** (Incluye confianza en: televisión y prensa)

-   Esta agrupación sustenta al ser la televisión y la prensa medios tradicionales de comunicación que influyen en la opinión del público, y por tanto en sus niveles de confianza.

**F3 - Confianza en las Instituciones Políticas y Legales** (Incluye confianza en: gobierno, partidos políticos, parlamento, mecanismos electorales, servicio civil, cortes de justicia)

-   La agrupación se debe a que estas instituciones están involucradas en aspectos políticos y legales de nuestra sociedad.

**F4 - Confianza en las Instituciones de Seguridad** (Incluye confianza en: policía y fuerzas armadas)

**F5 - Confianza en Instituciones Educativas y Espirituales** (Incluye confianza en iglesias y universidades)

**F6 - Confianza en Instituciones Sociales** (Incluye confianza en: sindicatos, grandes empresas, organizaciones ambientales, organizaciones de mujeres, organizaciones humanitarias/caridad)

**Graficamos:**

```{r}
semPaths(modelo3, intercepts = FALSE,edge.label.cex=1.5, optimizeLatRes = TRUE, groups = "lat",pastel = TRUE, exoVar = FALSE, sizeInt=5,edge.color ="black",esize = 6, label.prop=2,sizeLat = 6,"std", layout="circle2")
```

Podemos observar los 6 factores creados. Se observa que la mayoría de los factores cuentan con una fuerte relación con sus variables debido a que presentan una línea fuerte. Por otro lado, la información que no es explicable con su factor es una minoría, puesto que solo la variable "confianza en religión" es mayor que la carga factorial que su factorial. Así, se observa en general que se ofrece una correlación bastante explicativa.

**Guardamos los componentes como nuevas variables:**

```{r}
factores_puntajes <- predict(modelo3)
WVS_pais <- cbind(WVS_pais, factores_puntajes)
```

**Estandarizamos del 1 al 4:**

```{r}
library(BBmisc)
WVS_pais$F1_ConfianzaenlasOI = normalize(WVS_pais$F1_ConfianzaenlasOI,
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F2_ConfianzaenlosMediosdeComunicación = normalize(WVS_pais$F2_ConfianzaenlosMediosdeComunicación, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F3_ConfianzaenlasInstitucionesPolíticasyLegales = normalize(WVS_pais$F3_ConfianzaenlasInstitucionesPolíticasyLegales, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F4_Confianzaenlasinstitucionesdeseguridad = normalize(WVS_pais$F4_Confianzaenlasinstitucionesdeseguridad, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F5_ConfianzaenInstitucionesEducativasyEspirituales = normalize(WVS_pais$F5_ConfianzaenInstitucionesEducativasyEspirituales , 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F6_ConfianzaenInstitucionesSociales = normalize(WVS_pais$F6_ConfianzaenInstitucionesSociales , 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
```

Los niveles de confianza se clasifican de la siguiente manera:

Nivel 4 - Muy Alta confianza

Nivel 3 - Alta confianza

Nivel 2 - Media-Baja Confianza

NIvel 1 - Baja confianza

## 3.3. Análisis de Conglomerados Jerárquicos

Ahora aplicaremos el análisis de conglomerados K-means (No Jerárquico) para encontrar subgrupos de países que sean homogéneos entre sí y heterogéneos respecto a los otros grupos según los factores generados previamente

Asignamos el nombre de los países como primera columna para poder identificarlos en el proceso de crear los subgrupos.

```{r}

rownames(WVS_pais) = WVS_pais[,34]
```

```{r}
WVS_factores1 <- WVS_pais%>%select(F1_ConfianzaenlasOI,F2_ConfianzaenlosMediosdeComunicación,F3_ConfianzaenlasInstitucionesPolíticasyLegales,F4_Confianzaenlasinstitucionesdeseguridad,F5_ConfianzaenInstitucionesEducativasyEspirituales, F6_ConfianzaenInstitucionesSociales)
```

```{r}
MATRI_dist <- get_dist(WVS_factores1, method = "euclidean", stand = TRUE)

```

**Elaboramos matriz de distancias**

```{r}
fviz_dist(MATRI_dist, gradient = list(low = "blue", mid = "white", high = "red"))
```

EXPLICAR QUE SIGNIFICA COLORES

**Calculo de clúster**

```{r}
resnumclust=NbClust(WVS_factores1, distance = "euclidean", min.nc= 2, max.nc= 10, 
                       method = "ward.D")
```

DECIR QUE NOS RECOMIENDA EL R --\> 3 CLUSTERS por eso a continuacion hacemos 3 cortes

```{r}
res1 <- hcut(WVS_factores1, k = 3, stand = TRUE, hc_method = "ward.D")
```

**Dendograma**

desarrollamos el dendograma con la formula a continuaacion:

```{r}
fviz_dend(res1, rect = T, cex = 0.5)
```

**Graficamos los clústers**

```{r}
fviz_cluster(res1, data = WVS_factores1)
```

**Agregamos a nuestra base y a nuestra subdata de factores**

```{r}
WVS_pais$clus_instituciones=as.factor(res1$cluster)
WVS_factores1$clus_instituciones=as.factor(res1$cluster)
```

**Vemos las características de los grupos**

```{r}
table(WVS_pais$clus_instituciones)
```

Observamos características

```{r}
clust_car=WVS_factores1 %>%
  mutate(Cluster = res1$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("mean")
clust_car

```

Explicación Valdría la pena alternar el cluster 2 y 3 para que exista un orden visible.

cluster 1 es el caso donde se agrupa mas los paises con mas confianza en instituciones

cluster 2 menos confianza

cluster 3 confianza intermedia

## 3.4. Mapas

Procedemos a hacer mapas de acuerdo a la agrupación de los países en base a los clusters creados

```{r}
folder="world_map"
file="world_map.shp"
destination <- file.path("C:/Users/ASUS/Desktop/Estadística2_MAPAS_claseTeórica/world_map", file)
file.copy(from = file.path(folder, file), to = destination)


mapaMundo = rgdal::readOGR(destination,stringsAsFactors=FALSE) 

plot(mapaMundo)
```

```{r}
names(WVS_factores1)

```

```{r}
WVS_factores1$NAME=rownames(WVS_factores1)
worldmap = st_read(destination,stringsAsFactors=FALSE)
```

```{r}
cluster_map=inner_join(worldmap,WVS_factores1 )
names(WVS_factores1)
```

**Mapa según los colores del gráfico de clústers:**

Configuramos nuestros países sin data:

```{r}
missing_data <- cluster_map[is.na(cluster_map$clus_instituciones), ]
```

```{r}
mapa <- cluster_map %>%
  ggplot() +
  geom_sf(aes(fill = clus_instituciones),lwd=0.2)+
 geom_sf_text(aes(label = NAME), size = 2
                ,family="sans",fontface = "bold",check_overlap = TRUE )+
   scale_fill_manual(values = c("khaki", "#FFCC66"),labels =c("Grupo 1","Grupo 2"))+
 labs(title = "pensar en un nombre adecuado ", subtitle = "pensar en un nombre adecuado",
      caption = "pensar en un nombre adecuado",
      fill="pensar en un nombre adecuado") +
theme_bw()+
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks =  element_blank(),
    axis.title = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())+
   theme(
    legend.position=c(0.1, 0.3),
    legend.title = element_text(
      colour="black", size=10, 
                                      face="bold")#"left","buttom"
      )
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = c(0.1, 0.3),
    legend.title = element_text(colour = "black", size = 5, face = "bold")
  )
```

```{r}
print(mapa)
```

# 4. Presentación y análisis de resultados - Confianza interpersonal

Para el análisis de confianza interpersonal se utilizaran, como antes se mencionó, 6 variables que se encuentran desde la Q58 a la Q63, las cuales corresponden a la confianza interpersonal.

## 4.1. Análisis Factorial Exploratorio

Revisamos la estructura de nuestra subdata configurada previamente:

```{r}
str(subdata_2)
```

Encontramos nuestro "data.frame" en formato tibble, lo cual no nos permite aplicar el análisis factorial. Lo convertimos adecuadamente en un data.frame.

```{r}
subdata_2=as.data.frame(subdata_2)
```

A pesar de haber limpiado la data previamente, al cambiar de formato, nos sercioramos de eliminar los NA's:

```{r}
subdata_2 <- subdata_2[complete.cases(subdata_2),]
subdata_2=na.omit(subdata_2)
```

Creamos nuestra matriz de correlación, en el que por la naturaleza de la variable (categórica-ordinal) se busca aplicar una correlación policórica. No obstante, con este método presentamos problemas al momento de correr el código, debido a que R reconoce cada decimal de nuestros datos como un nivel. Por ende, no se reconoce la naturaleza ordinal de nuestras variables en R, por lo que se aplica hetcor que es una heramienta nos llevaría al mismo resultado por su naturaleza numérica, que se complementa con la función correlations.

```{r}

corMatrix2=hetcor(subdata_2)$correlations
corMatrix
```

Creamos un objeto con la matriz de correlaciones:

```{r}
cor.plot(corMatrix2,
          numbers=T, #Se muestren los numeros de las correlaciones
          upper=F, #Que aparezca la segunda parte
          main= "Matriz de correlaciones",#Titulo
          show.legend=T)#Mostrar leyenda
```

Creamos un objeto con la matriz de correlaciones, la cual es una tabla que mide y muestra la interdependencia en las relaciones entre variables. Por ello, como se puede observar, nuestra tabla es una matriz de correlación en el que la relación identica entre variables es consigo mismas a través de la diagonal de 1, que hace referencia a la matrisz de identidad entre las mismas variables.

**Verificamos que los datos se puedan factorizar:**

Verificamos que los datos se puedan factorizar a través del test de Kaiser-Meyer-Olkin (KMO), el cual permite observar las variables observables con la finalidad de determinar si existe una correlación real y si los datos son factorizables.

**Test de Kaiser-Meyer-Olkin factor adequacy**

```{r}
psych::KMO(subdata_2)
```

Observamos que los resultados se encuentran entre 0.46 a 0.83. Asímismo, el Overall MSA es de 0.73, de modo que, al ser mayor a 0.5 y 0.7, los datos de todas nuestras variables son factorizables.

**Verificamos si la matriz de correlaciones es adecuada:**

**Test de Bartlett**

Este test consiste en indicar si la matriz de correlaciones que hemos observado es una matriz de identidad o una matriz de correlación.

```{r}
cortest.bartlett(corMatrix2,n=nrow(subdata_2))$p.value>0.05
```

H0= Matriz de correlación es igual a la matriz de identidad

Ha= Matriz de correlación NO es igual a la matriz de identidad (\<0.05)

Con el "FALSE" se rechaza la H0 y se asume un valor menor a 0.05, que indica que la matriz de correlación es igual que la matriz de identidad. Por ende, se adopta la Ha, que indica que la matriz es adecuada.

**Determinamos la cantidad de factores a desarrollar**

**Gráfico de sedimentación**

Elaboramos este gráfico para determinar en cuántos factores podemos redimensionar nuestra base de datos.

```{r}
fa.parallel(corMatrix2, fm="pa", fa="fa", main = "Scree Plot")
```

**Eigen values - Autovalores**

```{r}
eigenf2 = eigen(cor(subdata_2, use="complete"))
eigenf$values
```

Después de realizar el gráfico de sedimentación y observar los autovalores, elegimos construir 2 factores, puesto que, por la cantidad limitada de variables que conforman la dimensión de confianza interpersonal, elegir un número mayor implicaría que existan factores que correspondan solamente con una variable.

**Solicitamos el número de componentes:**

Rotamos para acomodar las variables latentes de tal manera que se correlacionen con un grupo de datos y no con otro.

```{r}
factorial_exp2 <- fa(subdata_2,nfactors = 2,rotate="varimax", fm="minres")
factorial_exp2
```

Diagramamos

Observamos qué variables conforman cada uno de los factores así como cuando aporta cada una a estos componentes.

```{r}
fa.diagram(factorial_exp2)
```

```{r}
print(factorial_exp2$loadings,cutoff = 0.6)
```

Evaluamos el Análisis Factorial Exploratorio solicitado ¿Qué variables aportaron mas a los factores?

```{r}
sort(factorial_exp2$communality)
```

Texto ¿Qué variables contribuyen a mas de un factor?

```{r}
sort(factorial_exp2$complexity)
```

texto ¿Qué variables tiene un componente "único" más grande?

```{r}
sort(factorial_exp2$uniquenesses)
```

texto

Explicar por qué es suficiente este resultado y no vamos a hacer AFC

```{r}
factorial_confinst<-as.data.frame(factorial_exp2$scores)
head(factorial_confinst)
summary(factorial_confinst)
```

```{r}
WVS_pais$confinsti_lejana<- factorial_confinst$MR1
WVS_pais$confinsti_cercana<- factorial_confinst$MR2
```

texto: describir cada factor

```{r}
#install.packages("BBmisc")
library(BBmisc)
WVS_pais$confinsti_lejana = normalize(WVS_pais$confinsti_lejana, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(0, 4))
 WVS_pais$confinsti_cercana= normalize(WVS_pais$confinsti_cercana, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(0, 4))

```

## 4.2. Análisis de Conglomerados Jerárquicos

```{r}
WVS_factores2 <- WVS_pais%>%select(confinsti_lejana, confinsti_cercana)
```

```{r}
dist_inter <- get_dist(WVS_factores2, method = "euclidean", stand = TRUE)
```

```{r}
fviz_dist(dist_inter,gradient = list(low="blue", mid="white", high ="red"))
```

explicar pq uisamos euclidean

```{r}

interclust=NbClust(WVS_factores2, distance = "euclidean", min.nc= 2, max.nc= 10, 
                       method = "ward.D")
```

El gráfico nos indica 6 combinaciones para la cantida de cortes. En ese sentido, se decidió elegir 3 cortes para facilitar la comparación con la confianza en las instituciones.

```{r}

dendointer <- hcut(WVS_factores2, k = 3, stand = TRUE, hc_method = "ward.D")

```

```{r}

fviz_dend(dendointer, rect = T, cex = 0.5)
```

```{r}
fviz_cluster(dendointer, data = WVS_factores2)
```

Agregamos a nuestra base

```{r}
WVS_pais$clus_interpersonal=as.factor(dendointer$cluster)
```

Vemos las características de los grupos

```{r}
table(WVS_pais$clus_interpersonal)
```

Observamos características

```{r}
clus_carac=WVS_factores2 %>%
  mutate(Cluster2 = dendointer$cluster ) %>%
  group_by(Cluster2) %>%
  summarise_all("mean")
clus_carac

```

Explicar

## 4.3. Mapas
