---
title: "TITULO"
author: "Nicolas Silva"
date: "2023-06-01"
output: rmdformats::readthedown
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1.Introducción

texto

## 1.1. Pregunta de investigación

cómo se agrupan los países según su confianza en las instituciones y confianza interpersonal

## 1.2. Hipótesis

texto

# **2. Metodología: base de datos y métodos seleccionados**

## 2.1. Base de datos:

La presente investigación se basa en el "2017-2021 World Values Survey Wave 7". Esta base tiene como propósito recolectar los cambios en creencias, valores y motivaciones de las personas en casi 100 países que continen casi el 90% de la población del mundo. Esta investigación utilizará la versión más actual del cuestionario que corresponde a la sétima ola de WVS, cada ola significando un número más grande de sociedades que se han cubierto.No obstante, tras el proceso de limpieza, y debido a los NA presentados en la base de datos, no se utilizarán todos los países que cubre la sétima ola, sino solo 55 países.

Los 55 países son los siguientes: Alemania, Argentina, Armenia, Bangladesh, Bolivia, Brasil, Canadá, Chile, Colombia, Chipre, República Checa (Czechia), Ecuador, Etiopía, Eslovaquia, Estados Unidos, Filipinas, Grecia, Guatemala, Hong Kong, Indonesia, Irán, Iraq, Irlanda del Norte, Japón, Jordania, Kazajstán, Kenia, Korea (República de), Kirguistán, Líbano, Libia, Malasia, Maldivias, Marruecos, Mongolia, México, Myanmar, Nigeria, Países Bajos, Pakistán, Puerto Rico, Reino Unido, Rumania, Rusia, Serbia, Singapur, Tayikistán, Tailandia, Túnez, Turquía, Ucrania, Uruguay, Venezuela, Vietnam, Zimbabue.

El cuestionario WVS-7 consta de 290 preguntas que se dividen en 14 categorías que pretenden medir: "Valores sociales, actitudes y estereotipos"; "Felicidad y bienestar"; "Capital social, confianza y membresía organizacional"; "Valores económicos", "Corrupción"; "Migración"; "Seguridad"; "Índice postmaterial"; "Ciencia y tecnología"; "Valores culturales"; "Valores éticos y normas"; "Interés y participación política"; "Cultura política y régimenes políticos"; y "Demografía".

Para los fines de esta investigación se ha decidido utilizar la categoría de "Capital social, confianza y membresía organizacional", en específico se ha seleccionado las preguntas entre Q58 y 89.

Las primera sección de esta categoría, entre Q58-Q63, pregunta la confianza que personas sienten hacia varios grupos interpersonales como la familia, vecindario, conocidos, personas que conocen por primera vez, personas de otras religiones y extranjeros. Las respuestas varían en 4 grados desde "Confío completamente", "Confío parcialmente", "No confío demasiado" hasta "No confío en absoluto".

La segunda sección de esta categoría, entre Q63-Q89, pregunta la confianza que personas sienten hacia instituciones de varias dimensiones como: las Iglesias, las Fuerzas Armadas, la prensa, la Televisión, sindicatos, la policía, las cortes, el gobierno, partidos políticos, parlamento, servicio civil, universidades, elecciones, compañias grandes, bancos, organizaciones ambientales, organizaciones de mujeres, organizaciones humanitarias/caridad, organización regional relevante, las Naciones Unidas, el Fondo Internacional Monetario, Corte Penal Internacional, La Organización del Tratado del Atlántico Norte, el Banco Mundial, la Organización Mundial de la salud y la Organización Mundial del Comercio . Las respuestas varían en 4 grados desde "Sustrancialmente", "Un montón", "No mucho", "Nada en absoluto".



**Abrimos las librerías:**

```{r message=FALSE, warning=FALSE}
library(rio)
library(dplyr)
library(tidyverse)
library(car)
library(countrycode)
library(polycor)
library(psych)
library(GPArotation)
library(lavaan)
library(semPlot)
library(rmdformats)
library(dendextend)
library(factoextra)
library(ggdendro)
options(scipen = 999)
library(NbClust)
library(latexpdf)
library(data.table)
library(tidyr)
library(sp)
library(BBmisc)
library(sf)
library(rgdal)
library(rgeos)
library(maptools)
library(ggplot2)
library(sf)
```

**Cargamos la base de datos:**

```{r}
WVS = import("WVS.rdata")
```

**Seleccionamos las variables que se utilizarán:**

```{r}
WVS_A <- WVS%>%select(B_COUNTRY,Q58:Q82, Q83:Q89)


```

**Limpiamos la base, eliminando los valores correspondientes a respuesta no contabilizables y los valores perdidos.**

```{r}
WVS_A <- WVS_A %>% 
  mutate(across(everything(), ~if_else(. %in% c(-1, -2, -3, -4, -5), NA_integer_, .)))
WVS_A <- na.omit(WVS_A)
```

**Transformamos la información:**

Para mayor comodidad y representatividad, agrupamos la data por país y convertimos la información a nivel individual a información a nivel país a través del promedio y redondeo de resultados de acuerdo al país.

```{r}
WVS_pais<- WVS_A %>%
  group_by(B_COUNTRY) %>%
  summarize(across(Q58:Q89, mean, na.rm = TRUE))
```

**Renombramos las variables:**

```{r}
WVS_pais <- WVS_pais%>%rename(Codigo=B_COUNTRY, familia=Q58, barrio=Q59, conocidos=Q60, rconocidos=Q61, preligion=Q62, nacionalidad=Q63, confianza_religion=Q64,confianza_FFAA=Q65,confianza_prensa= Q66,confianza_television= Q67, confianza_sindicatos = Q68, confianza_policia = Q69, confianza_justicia = Q70, confianza_gobierno = Q71, confianza_partidos = Q72, confianza_parlamento = Q73, confianza_serviciocivil = Q74, confianza_universidades = Q75, confianza_elecciones = Q76, confianza_granempresa = Q77, confianza_bancos =Q78, confianza_org_ambiental =Q79, confianza_org_mujeres = Q80, confianza_org_humanitaria = Q81, confianza_org_regional_relevante = Q82, confianza_onu = Q83, confianza_fmi = Q84, confianza_cci = Q85, confianza_otan = Q86, confianza_bm =Q87, confianza_oms =Q88, confianza_omc =Q89)
```

En el mismo sentido, agregamos una columna nueva para el nombre del país, de modo que sea más fácil identificar la correspondencia de los valores:

```{r}
WVS_pais$Codigo <- as.character(WVS_pais$Codigo)
data=import("all.csv")
WVS_pais$Nombre <- data$name[match(WVS_pais$Codigo, data$`country-code`)]
```

```{r}
WVS_pais$Nombre <- ifelse(WVS_pais$Codigo == 909, "Northern Ireland", WVS_pais$Nombre)

```

**Asignamos una subdata tanto para trabajar la confianza en las instituciones como la interpersonal**

[**A) Confianza interpersonal**]{.underline}

```{r}
subdata_1=WVS_pais[,c(8:33)]
subdata_1
```

Ordenamos de manera ascendente para hacer más comprensible la información.

1.   Confianza en las iglesias

```{r}
subdata_1$confianza_religion= recode(subdata_1$confianza_religion, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_religion)
```

2.  Confianza en las Fuerzas Armadas

```{r}
subdata_1$confianza_FFAA= recode(subdata_1$confianza_FFAA, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_FFAA)
```

3.  Confianza en la prensa

```{r}
subdata_1$confianza_prensa= recode(subdata_1$confianza_prensa, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_prensa)
```

4.  Confianza en la televisión

```{r}
subdata_1$confianza_television= recode(subdata_1$confianza_television, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_religion)
```

5.  Confianza en los sindicatos

```{r}
subdata_1$confianza_sindicatos= recode(subdata_1$confianza_sindicatos, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_sindicatos)
```

6.  Confianza en la policía  

```{r}
subdata_1$confianza_policia= recode(subdata_1$confianza_policia, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_policia)
```

7.  Confianza en las cortes de justicia

```{r}
subdata_1$confianza_justicia= recode(subdata_1$confianza_justicia, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_justicia)
```

8.  Confianza en el gobierno

```{r}
subdata_1$confianza_gobierno= recode(subdata_1$confianza_gobierno, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_gobierno)
```

9.  Confianza en los partidos políticos

```{r}
subdata_1$confianza_partidos= recode(subdata_1$confianza_partidos, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_partidos)
```

10. Confianza en el parlamento

```{r}
subdata_1$confianza_parlamento= recode(subdata_1$confianza_parlamento, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_parlamento)
```

11. Confianza en el servicio civil

```{r}
subdata_1$confianza_serviciocivil= recode(subdata_1$confianza_serviciocivil, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_serviciocivil)
```

12. Confianza en las universidades

```{r}
subdata_1$confianza_universidades= recode(subdata_1$confianza_universidades, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_universidades)
```

13. Confianza en los mecanismos electorales

```{r}
subdata_1$confianza_elecciones= recode(subdata_1$confianza_elecciones, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_elecciones)
```

14. Confianza en las grandes empresas

```{r}
subdata_1$confianza_granempresa= recode(subdata_1$confianza_granempresa, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_granempresa)
```

15. Confianza en la banca

```{r}
subdata_1$confianza_bancos= recode(subdata_1$confianza_bancos, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_bancos)
```

16. Confianza en las organizaciones ambientales

```{r}
subdata_1$confianza_org_ambiental= recode(subdata_1$confianza_org_ambiental, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_org_ambiental)
```

17. Confianza en las organizaciones de mujeres

```{r}
subdata_1$confianza_org_mujeres= recode(subdata_1$confianza_org_mujeres, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_org_mujeres)
```

18. Confianza en las organizaciones humanitarias/caridad

```{r}
subdata_1$confianza_org_humanitaria= recode(subdata_1$confianza_org_humanitaria, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_org_humanitaria)
```

19. Confianza en Organización Regional relevante

```{r}
subdata_1$confianza_org_regional_relevante= recode(subdata_1$confianza_org_regional_relevante, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_org_regional_relevante)
```

20. Confianza en la Organización Mundial de la Salud

```{r}
subdata_1$confianza_onu= recode(subdata_1$confianza_onu, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_onu)
```

21. Confianza en el Fondo Monetario Internacional

```{r}
subdata_1$confianza_fmi= recode(subdata_1$confianza_fmi, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_fmi)
```

22. Confianza en el Corte Penal Internacional

```{r}
subdata_1$confianza_cci= recode(subdata_1$confianza_cci, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_cci)

```

23. Confianza en la Organización del Tratado del Atlántico Norte

```{r}
subdata_1$confianza_otan= recode(subdata_1$confianza_otan, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_otan)
```

24. Confianza en el Banco Mundial

```{r}
subdata_1$confianza_bm= recode(subdata_1$confianza_bm, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_bm)
```

25. Confianza en la Organización Mundial de la Salud

```{r}
subdata_1$confianza_oms= recode(subdata_1$confianza_oms, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_oms)

```

26. Confianza en la Organización Mundial del Comercio

```{r}
subdata_1$confianza_omc= recode(subdata_1$confianza_omc, "1=4;2=3;3=2;4=1")
table(subdata_1$confianza_omc)
```

**b) [Confianza interpersonal]{.underline}**

Creamos la subdata para confianza interpersonal:

```{r}
subdata_2 <- WVS_pais[,c(2:7)]
```

Ordenamos de manera ascendente.

1. Confianza en su familia

```{r}
subdata_2$familia= recode(subdata_2$familia, "1=4;2=3;3=2;4=1")
table(subdata_2$familia)
```

2.  Confianza en su vecindario

```{r}
subdata_2$barrio= recode(subdata_2$barrio, "1=4;2=3;3=2;4=1")
table(subdata_2$barrio)
```

3.  Confianza en conocidos

```{r}
subdata_2$conocidos= recode(subdata_2$conocidos, "1=4;2=3;3=2;4=1")
table(subdata_2$conocidos)
```

4.  Confianza en recién conocidos por primera vez

```{r}
subdata_2$rconocidos= recode(subdata_2$rconocidos, "1=4;2=3;3=2;4=1")
table(subdata_2$rconocidos)
```

5.  Confianza en personas de otra religión

```{r}
subdata_2$preligion= recode(subdata_2$preligion, "1=4;2=3;3=2;4=1")
table(subdata_2$preligion)
```

6.  Confianza en extranjeros

```{r}
subdata_2$nacionalidad= recode(subdata_2$nacionalidad, "1=4;2=3;3=2;4=1")
table(subdata_2$nacionalidad)

```

## 2.2. Métodos seleccionados

texto

# 3. Presentación y análisis de resultados - Confianza en las instituciones

Trabajo con 26 variables que refieren a la confianza en las instituciones

## 3.1. Análisis factorial exploratorio:

```{r}
str(subdata_1)
```

### Calculamos la matriz de correlación

Al estar trabajando con variables categóricas ordinales, obtamos por ejecutar la correlación policórica.

```{r}

poly_cor1 = polychoric(subdata_1)
poly_cor1

```

### 

**Creamos un gráfico con la matriz de correlaciones:**

```{r}
corMatrix=poly_cor1$rho 
cor.plot(corMatrix,
          numbers=T, #Se muestren los numeros de las correlaciones
          upper=F, #Que aparezca la segunda parte
          main= "Matriz de correlaciones",#Titulo
          show.legend=T)#Mostrar leyenda
```

Con la matriz previa podemos observar la proporción de relación entre dos varibales. Ello es explicado mediante los colores de la matriz y sus explicaciones en la leyenda. Mientras mas azul, mas cercano a uno, mayor será dicha proporción. Esto se elaboró, para buscar si existen grupos de variables correlacionaddas, y posteriormente, conformar las variables latentes.

**Verificamos si los datos son factorizables:**

Test de Kaiser-Meyer-Olkin factor adequacy (KMO):

```{r}
psych::KMO(subdata_1) 
```

Escala - Test KMO

0 a 0.5= no se debe de realizar

0.5 a 0.7= aceptable

0.7 a 1= muy bueno

Con esta prueba lo que buscamos es que la correlación parcial sea mayor a 0.5. Por ende, se espera que los valores resultantes, esten más ceranos a 1. En este caso, observamos que los resultados se encuentran entre 0.47 hasta 0.91, con un Overall MSA de 0.82, lo cual nos indica que nuestras datos de las variables son factorizables.

**Verificamos si la matriz de correlación es adecuada**

Test de Bartlett

```{r}
cortest.bartlett(corMatrix,n=nrow(subdata_1))$p.value>0.05
```

H0= Matriz de correlación es igual a la matriz de identidad

Ha= Matriz de correlación NO es igual a la matriz de identidad (\<0.05)

Con este test, lo que buscamos es que se rechace la H0, la cual implica que la matriz de correlacion es una matriz identidad. "FALSE" nos indica que existe un p-value mayor a 0.05, de modo que se rechaza la H0 y se acepta la Ha, de modo que la matriz sí es adecuada.

### **Determinamos cuántos factores latententes puede redimensionar la data:**

### **Grafico de sedimentación:**

Elaboramos este gráfico para determinar en cuántos factores podemos redimensionar nuestros variables y valores de nuestra subdata.

```{r}
fa.parallel(corMatrix, fm="pa", fa="fa", main = "Scree Plot")
```

### 

**Eigen values - Autovalores**

```{r}
eigenf = eigen(cor(subdata_1, use="complete"))
eigenf$values
```

(Criterio de Kaiser : se deben retener todos los factores que tengan un autovalor mayor de 1.0.)

Tras observar los autovalores (cantidad de la varianza total que está explicada por cada factor) y el gráfico de sedimentación podemos concluir que los más apropiado sería distribuir las variables en cuatro (4) factores. Elegir un número mayor a este, implicaría arriesgarnos a una menor exactitud y efectividad de los factores para responder a nuestra pregunta de investigación.

### **Solicitamos el número de componentes**

Rotamos para acomodar las variables latentes para que se correlacionen con su respectivo grupo de datos.

Utilizamos la rotación varimax, puesto que minimiza el número de variables con cargas altas en un factor, mejorando así la interpretación de factores.

```{r}
factorial_exp1 <- fa(subdata_1,nfactors = 5,rotate="varimax", fm="minres")
factorial_exp1
```

Se nos muestra la capacidad explicativa de los factores respecto a las variables, de modo que se establecen relaciones entre estas.

### **Diagramamos**

Observamos los factores y por cuáles variables se encuentran compuestas en relación a sus autovalores encontrados. Esto se hace en función de la varianza que comparten las variables con el factor. Todas las variables comparten varianza, pero algunas han compartido más con un factor que con los otros dos.

```{r}
fa.diagram(factorial_exp1)
```

```{r}
print(factorial_exp1$loadings,cutoff = 0.4)
```

**Evaluamos el Análisis Factorial Exploratorio solicitado**

texto

-   ¿Qué variables aportaron mas a los factores?

```{r}
sort(factorial_exp1$communality)
```

texto

-   **¿Qué variables contribuyen a mas de un factor?**

```{r}
sort(factorial_exp1$complexity)
```

texto

-   **¿Qué variables observables tiene un componente "único" más grande?**

```{r}
sort(factorial_exp1$uniquenesses)
```

texto Explicar por qué esto es insuficiente.

## 3.2. Análisis Factorial Confirmatorio

### **Analisis confirmatorio**

Explicar

```{r}
Modelo_confir1 = "FAC1 =~confianza_bm+confianza_fmi+confianza_omc+confianza_onu+confianza_org_regional_relevante+confianza_cci+confianza_granempresa+confianza_bancos+confianza_otan
                FAC2 =~ confianza_org_ambiental+confianza_org_mujeres+confianza_org_humanitaria+confianza_universidades
                FAC3 =~ confianza_parlamento+confianza_prensa+confianza_elecciones+confianza_gobierno+confianza_television+confianza_partidos+confianza_serviciocivil
                FAC4 =~ confianza_religion+confianza_sindicatos+confianza_FFAA
FAC5 =~ confianza_justicia+confianza_policia"

Modelo_confir1
```

```{r}
modelo=cfa(Modelo_confir1, data=subdata_1)
summary(modelo,fit.measures=F)
```

Observamos que la confianza en las FF.AA. tiene un p-value mayor a 0.05. En ese sentido, para evitar conflictos en la creación de los factores, decidimos removerlo.

```{r}
Modelo_confir2 ="FAC1 =~confianza_bm+confianza_fmi+confianza_omc+confianza_onu+confianza_org_regional_relevante+confianza_cci+confianza_granempresa+confianza_bancos+confianza_otan
                FAC2 =~ confianza_org_ambiental+confianza_org_mujeres+confianza_org_humanitaria+confianza_universidades
                FAC3 =~ confianza_parlamento+confianza_prensa+confianza_elecciones+confianza_gobierno+confianza_television+confianza_partidos+confianza_serviciocivil
                FAC4 =~ confianza_religion+confianza_sindicatos
FAC5 =~ confianza_justicia+confianza_policia"
```

```{r}
modelo2=cfa(Modelo_confir2, data=subdata_1)
summary(modelo2,fit.measures=F)
```

Sin embargo, a pesar de no contar con errores en la asignación de factores, las asignaciones propias de R carecen de sentido en algunos casos. Asimismo, considerando conocimiento desde la Ciencia Política, se puede construir una distribución de patrones que organice adecuadamente la confianza institucional.

```{r}
Modelo_confir3 = "F1_Confianza en las OI =~confianza_org_regional_relevante+confianza_onu+confianza_bm+confianza_oms+confianza_omc+confianza_otan+ confianza_cci+confianza_fmi
                 F2_Confianza en los Medios de Comunicación  =~ confianza_television + confianza_prensa
                F3_Confianza en las Instituciones Políticas y Legales =~ confianza_gobierno+confianza_partidos+confianza_parlamento+confianza_elecciones+confianza_serviciocivil + confianza_justicia
              F4_Confianza en las instituciones de seguridad  =~ confianza_policia
                F5_Confianza en Instituciones Educativas y Espirituales =~confianza_religion+ confianza_universidades
F6_Confianza en Instituciones Sociales=~ confianza_sindicatos + confianza_granempresa+
confianza_org_ambiental+confianza_org_mujeres+confianza_org_humanitaria"
```

```{r}
modelo3=cfa(Modelo_confir3, data=subdata_1)
summary(modelo3,fit.measures=F)
```

### Tras lo realizado, se obtuvieron seis factores:

texto

### Graficamos:

```{r}
semPaths(modelo3, intercepts = FALSE,edge.label.cex=1.5, optimizeLatRes = TRUE, groups = "lat",pastel = TRUE, exoVar = FALSE, sizeInt=5,edge.color ="black",esize = 6, label.prop=2,sizeLat = 6,"std", layout="circle2")
```

texto

### **Guardamos los componentes como nuevas variables:**

texto

```{r}
factores_puntajes <- predict(modelo3)
WVS_pais <- cbind(WVS_pais, factores_puntajes)
```

### **Estandarizamos del 1 al 4:**

```{r}
library(BBmisc)
WVS_pais$F1_ConfianzaenlasOI = normalize(WVS_pais$F1_ConfianzaenlasOI,
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F2_ConfianzaenlosMediosdeComunicación = normalize(WVS_pais$F2_ConfianzaenlosMediosdeComunicación, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F3_ConfianzaenlasInstitucionesPolíticasyLegales = normalize(WVS_pais$F3_ConfianzaenlasInstitucionesPolíticasyLegales, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F4_Confianzaenlasinstitucionesdeseguridad = normalize(WVS_pais$F4_Confianzaenlasinstitucionesdeseguridad, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F5_ConfianzaenInstitucionesEducativasyEspirituales = normalize(WVS_pais$F5_ConfianzaenInstitucionesEducativasyEspirituales , 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
WVS_pais$F6_ConfianzaenInstitucionesSociales = normalize(WVS_pais$F6_ConfianzaenInstitucionesSociales , 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(1, 4))
```

Explicar los niveles de los factores --\> texto

## 3.3. Análisis de Conglomerados Jerárquicos

Ahora aplicaremos el análisis de conglomerados K-means (No Jerárquico) para encontrar subgrupos de países que sean homogéneos entre sí y heterogéneos respecto a los otros grupos según los factores generados previamente

Asignamos el nombre de los países como primera columna para poder identificarlos en el proceso de crear los subgrupos.

```{r}
rownames(WVS_pais) = WVS_pais[,34]
```

```{r}
WVS_factores1 <- WVS_pais%>%select(F1_ConfianzaenlasOI,F2_ConfianzaenlosMediosdeComunicación,F3_ConfianzaenlasInstitucionesPolíticasyLegales,F4_Confianzaenlasinstitucionesdeseguridad,F5_ConfianzaenInstitucionesEducativasyEspirituales, F6_ConfianzaenInstitucionesSociales)
```

```{r}
MATRI_dist <- get_dist(WVS_factores1, method = "euclidean", stand = TRUE)

```

Elaboramos matriz de distancias

```{r}
fviz_dist(MATRI_dist, gradient = list(low = "blue", mid = "white", high = "red"))
```

Calculo de clúster

```{r}
resnumclust=NbClust(WVS_factores1, distance = "euclidean", min.nc= 2, max.nc= 10, 
                       method = "ward.D")
```

```{r}
res1 <- hcut(WVS_factores1, k = 3, stand = TRUE, hc_method = "ward.D")
```

Dendograma

```{r}
fviz_dend(res1, rect = T, cex = 0.5)
```

Grafico

```{r}
fviz_cluster(res1, data = WVS_factores1)
```

Agregamos a nuestra base y a nuestra subdata de factores

```{r}
WVS_pais$clus_instituciones=as.factor(res1$cluster)
WVS_factores1$clus_instituciones=as.factor(res1$cluster)
```

Vemos las características de los grupos

```{r}
table(WVS_pais$clus_instituciones)
```

Observamos características

```{r}
clust_car=WVS_factores1 %>%
  mutate(Cluster = res1$cluster) %>%
  group_by(Cluster) %>%
  summarise_all("mean")
clust_car

```

Explicación Valdría la pensa alternar el cluster 2 y 3 para que exista un orden visible.

## 3.4. Mapas

Procedemos a hacer mapas de acuerdo a la agrupación de los países en base a los clusters creados

```{r}
folder="world_map"
file="world_map.shp"
destination <- file.path("C:/Users/ASUS/Desktop/Estadística2_MAPAS_claseTeórica/world_map", file)
file.copy(from = file.path(folder, file), to = destination)


mapaMundo = rgdal::readOGR(destination,stringsAsFactors=FALSE) 

plot(mapaMundo)
```

```{r}
names(WVS_factores1)

```

```{r}
WVS_factores1$NAME=rownames(WVS_factores1)
worldmap = st_read(destination,stringsAsFactors=FALSE)
```

```{r}
cluster_map=inner_join(worldmap,WVS_factores1 )
names(WVS_factores1)
```

**Mapa según los colores del gráfico de clústers:**

Configuramos nuestros países sin data:

```{r}
missing_data <- cluster_map[is.na(cluster_map$clus_instituciones), ]
```

```{r}
mapa <- cluster_map %>%
  ggplot() +
  geom_sf(aes(fill = clus_instituciones),lwd=0.2)+
 geom_sf_text(aes(label = NAME), size = 2
                ,family="sans",fontface = "bold",check_overlap = TRUE )+
   scale_fill_manual(values = c("khaki", "#FFCC66"),labels =c("Grupo 1","Grupo 2"))+
 labs(title = "pensar en un nombre adecuado ", subtitle = "pensar en un nombre adecuado",
      caption = "pensar en un nombre adecuado",
      fill="pensar en un nombre adecuado") +
theme_bw()+
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks =  element_blank(),
    axis.title = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())+
   theme(
    legend.position=c(0.1, 0.3),
    legend.title = element_text(
      colour="black", size=10, 
                                      face="bold")#"left","buttom"
      )
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = c(0.1, 0.3),
    legend.title = element_text(colour = "black", size = 5, face = "bold")
  )
```

```{r}
print(mapa)
```

# 4. Presentación y análisis de resultados - Confianza interpersonal

Trabajo con 6 variables.

## 4.1. Análisis Factorial Exploratorio

APLICACIÓN DE ANÁLISIS FACTORIAL Y CONFIRMATORIO PARA INTERPERSONAL

Revisamos la estructura de nuestra subdata configurada previamente:

```{r}
str(subdata_2)
```

Encontramos nuestro "data.frame" en formato tibble, lo cual no nos permite aplicar el análisis factorial. Lo convertimos adecuadamente en un data.frame.

```{r}
subdata_2=as.data.frame(subdata_2)
```

A pesar de haber limpiado la data previamente, al cambiar de formato, nos sercioramos de eliminar los NA's:

```{r}
subdata_2 <- subdata_2[complete.cases(subdata_2),]
subdata_2=na.omit(subdata_2)
```

Creamos nuestra matriz de correlación:

```{r}

corMatrix2=hetcor(subdata_2)$correlations
corMatrix
```

Creamos un objeto con la matriz de correlaciones:

```{r}
cor.plot(corMatrix2,
          numbers=T, #Se muestren los numeros de las correlaciones
          upper=F, #Que aparezca la segunda parte
          main= "Matriz de correlaciones",#Titulo
          show.legend=T)#Mostrar leyenda
```

Verificamos que los datos se puedan factorizar:

Test de Kaiser-Meyer-Olkin factor adequacyf

```{r}
psych::KMO(subdata_2)
```

Observamos que los resultados se encuentran entre 0.46 a 0.83. Asímismo, el Overall MSA es de 0.73, de modo que, al ser mayor a 0.5 y 0.7, los datos de todas nuestras variables son factorizables.

Verificamos si la matriz de correlaciones es adecuada:

Test de Bartlett

```{r}
cortest.bartlett(corMatrix2,n=nrow(subdata_2))$p.value>0.05
```

H0= Matriz de correlación es igual a la matriz de identidad

Ha= Matriz de correlación NO es igual a la matriz de identidad (\<0.05)

Con el "FALSE" se rechaza la H0 y se asume un valor menor a 0.05, que indica que la matriz de correlación es igual que la matriz de identidad. Por ende, se adopta la Ha, que indica que la mtriz es adecuada.

Determinamos la cantidad de factores a desarrollar Gráfico de sedimentación

Elaboramos este gráfico para determinar en cuántos factores podemos redimencionar nuestra base de datos.

```{r}
fa.parallel(corMatrix2, fm="pa", fa="fa", main = "Scree Plot")
```

Eigen values - Autovalores

```{r}
eigenf2 = eigen(cor(subdata_2, use="complete"))
eigenf$values
```

Elegimos 2.

Solicitamos el número de componentes:

Rotamos para acomodar las variables latentes de tal manera que se correlacionen con un grupo de datos y no con otro.

```{r}
factorial_exp2 <- fa(subdata_2,nfactors = 2,rotate="varimax", fm="minres")
factorial_exp2
```

Diagramamos

Observamos qué variables conforman cada uno de los factores así como cuando aporta cada una a estos componentes.

```{r}
fa.diagram(factorial_exp2)
```

```{r}
print(factorial_exp2$loadings,cutoff = 0.6)
```

Evaluamos el Análisis Factorial Exploratorio solicitado ¿Qué variables aportaron mas a los factores?

```{r}
sort(factorial_exp2$communality)
```

Texto ¿Qué variables contribuyen a mas de un factor?

```{r}
sort(factorial_exp2$complexity)
```

texto ¿Qué variables tiene un componente "único" más grande?

```{r}
sort(factorial_exp2$uniquenesses)
```

texto

Explicar por qué es suficiente este resultado y no vamos a hacer AFC

```{r}
factorial_confinst<-as.data.frame(factorial_exp2$scores)
head(factorial_confinst)
summary(factorial_confinst)
```

```{r}
WVS_pais$confinsti_lejana<- factorial_confinst$MR1
WVS_pais$confinsti_cercana<- factorial_confinst$MR2
```

texto: describir cada factor

```{r}
#install.packages("BBmisc")
library(BBmisc)
WVS_pais$confinsti_lejana = normalize(WVS_pais$confinsti_lejana, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(0, 4))
 WVS_pais$confinsti_cercana= normalize(WVS_pais$confinsti_cercana, 
                                        method = "range", 
                                        margin=2, # by column
                                        range = c(0, 4))

```

## 4.2. Análisis de Conglomerados Jerárquicos

```{r}
WVS_factores2 <- WVS_pais%>%select(confinsti_lejana, confinsti_cercana)
```

```{r}
dist_inter <- get_dist(WVS_factores2, method = "euclidean", stand = TRUE)
```

```{r}
fviz_dist(dist_inter,gradient = list(low="blue", mid="white", high ="red"))
```

explicar pq uisamos euclidean

```{r}

interclust=NbClust(WVS_factores2, distance = "euclidean", min.nc= 2, max.nc= 10, 
                       method = "ward.D")
```

El gráfico nos indica 6 combinaciones para la cantida de cortes. En ese sentido, se decidió elegir 3 cortes para facilitar la comparación con la confianza en las instituciones.

```{r}

dendointer <- hcut(WVS_factores2, k = 3, stand = TRUE, hc_method = "ward.D")

```

```{r}

fviz_dend(dendointer, rect = T, cex = 0.5)
```

```{r}
fviz_cluster(dendointer, data = WVS_factores2)
```

Agregamos a nuestra base

```{r}
WVS_pais$clus_interpersonal=as.factor(dendointer$cluster)
```

Vemos las características de los grupos

```{r}
table(WVS_pais$clus_interpersonal)
```

Observamos características

```{r}
clus_carac=WVS_factores2 %>%
  mutate(Cluster2 = dendointer$cluster ) %>%
  group_by(Cluster2) %>%
  summarise_all("mean")
clus_carac

```

Explicar

## 4.3. Mapas
